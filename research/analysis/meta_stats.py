#!/usr/bin/env python3
"""Generate meta statistics for the dataset used in LaTeX."""

from pathlib import Path

import duckdb


def format_number(n: int) -> str:
    """Format a number with commas."""
    return f"{n:,}"


def format_billions(n: float) -> str:
    """Format a number as billions with 2 decimal places."""
    return f"{n / 1e9:.2f}"


def format_millions(n: float) -> str:
    """Format a number as millions with 1 decimal place."""
    return f"{n / 1e6:.1f}"


def main():
    base_dir = Path(__file__).parent.parent.parent
    trades_dir = base_dir / "data" / "trades"
    markets_dir = base_dir / "data" / "markets"
    fig_dir = base_dir / "research" / "fig"
    fig_dir.mkdir(parents=True, exist_ok=True)

    con = duckdb.connect()

    # Trade statistics
    trade_stats = con.execute(
        f"""
        SELECT
            COUNT(*) AS num_trades,
            SUM(count) AS total_volume,
            COUNT(DISTINCT ticker) AS num_tickers
        FROM '{trades_dir}/*.parquet'
        """
    ).fetchone()

    num_trades = trade_stats[0]
    total_volume = trade_stats[1]
    num_tickers_from_trades = trade_stats[2]

    # Market statistics
    market_stats = con.execute(
        f"""
        SELECT
            COUNT(*) AS num_markets,
            COUNT(DISTINCT event_ticker) AS num_events
        FROM '{markets_dir}/*.parquet'
        """
    ).fetchone()

    num_markets = market_stats[0]
    num_events = market_stats[1]

    # Generate LaTeX macros file
    tex_content = f"""% Auto-generated by meta_stats.py - do not edit manually
\\newcommand{{\\numTrades}}{{{format_number(num_trades)}}}
\\newcommand{{\\numTradesMillions}}{{{format_millions(num_trades)}}}
\\newcommand{{\\totalVolume}}{{{format_number(int(total_volume))}}}
\\newcommand{{\\totalVolumeBillions}}{{{format_billions(total_volume)}}}
\\newcommand{{\\numMarkets}}{{{format_number(num_markets)}}}
\\newcommand{{\\numEvents}}{{{format_number(num_events)}}}
"""

    output_path = fig_dir / "meta_stats.tex"
    output_path.write_text(tex_content)

    print(f"Statistics generated:")
    print(f"  Trades: {format_number(num_trades)}")
    print(f"  Total volume: ${format_billions(total_volume)}B")
    print(f"  Markets: {format_number(num_markets)}")
    print(f"  Events: {format_number(num_events)}")
    print(f"Output saved to {output_path}")


if __name__ == "__main__":
    main()
